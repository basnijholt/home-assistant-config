import{g as t,G as e}from"./engine-generic-b10fce62.js";import{ez as i,eA as s,eD as n}from"./card-4818d30e.js";import{E as a}from"./entity-camera-8c929fa4.js";class r extends a{constructor(){super(...arguments),this._ptzEntities=null}async initialize(t){return await super.initialize(t),await this._initializeCapabilities(t.hass,t.entityRegistryManager,t.stateWatcher),this}async _initializeCapabilities(e,s,n){const a=this.getConfig(),r=t(a);this._ptzEntities=await this._getPTZEntities(e,s);const c=this._ptzEntities?this._entitiesToCapabilities(this._ptzEntities):null,o=r||c?{...c,...r}:null;this._capabilities=new i({"favorite-events":!1,"favorite-recordings":!1,"remote-control-entity":!0,clips:!1,live:!0,menu:!0,recordings:!1,seek:!1,snapshots:!1,substream:!0,trigger:!0,...o&&{ptz:o}},{disable:a.capabilities?.disable,disableExcept:a.capabilities?.disable_except}),this._subscribeBasedOnCapabilities(n)}async _getPTZEntities(t,e){if(!this._entity?.device_id)return null;const i=await e.getMatchingEntities(t,(t=>t.device_id===this._entity?.device_id&&t.entity_id.startsWith("button.")&&!t.disabled_by)),s={pan_left:"left",pan_right:"right",tilt_up:"up",tilt_down:"down"},n={};for(const t of i)for(const[e,i]of Object.entries(s))t.entity_id.endsWith(`_${e}`)&&(n[i]=t.entity_id);return Object.keys(n).length?n:null}_entitiesToCapabilities(t){const e={};for(const i of Object.keys(t))e[i]=[s.Relative];return e}async executePTZAction(t,e,i){if(await super.executePTZAction(t,e,i))return!0;if(!this._ptzEntities)return!1;if("preset"===e)return!1;if("zoom_in"===e||"zoom_out"===e)return!1;if("stop"===i?.phase)return!0;const s=this._ptzEntities[e];return!!s&&(await t.executeActions({actions:[{action:"perform-action",perform_action:"button.press",target:{entity_id:s}}]}),!0)}}class c extends e{constructor(t,e,i){super(e,i),this._entityRegistryManager=t}getEngineType(){return n.TPLink}async createCamera(t,e){const i=new r(e,this,{eventCallback:this._eventCallback});return await i.initialize({entityRegistryManager:this._entityRegistryManager,hass:t,stateWatcher:this._stateWatcher})}getCameraMetadata(t,e){return{...super.getCameraMetadata(t,e),engineIcon:"tplink"}}}export{c as TPLinkCameraManagerEngine};
